From 54da70528a257ec832221569cfd9f3802bc79f37 Mon Sep 17 00:00:00 2001
From: Stefan Hansel <bluegaspode@gmail.com>
Date: Tue, 17 Jul 2012 23:54:21 +0200
Subject: [PATCH] allow to set searchtarget for SSDP discovery

---
 api/SSDPDB_ObjC.h   |    1 +
 ssdp/SSDPDB_ObjC.mm |   10 +++++++++-
 ssdp/ssdp.cpp       |   12 +++++++++---
 ssdp/ssdp.h         |    4 +++-
 4 files changed, 22 insertions(+), 5 deletions(-)

diff --git a/api/SSDPDB_ObjC.h b/api/SSDPDB_ObjC.h
index bd26cb3..98a533d 100755
--- a/api/SSDPDB_ObjC.h
+++ b/api/SSDPDB_ObjC.h
@@ -70,6 +70,7 @@
 -(int)removeObserver:(SSDPDB_ObjC_Observer*)obs;
 -(void)SSDPDBUpdate;
 -(void)setUserAgentProduct:(NSString*)product andOS:(NSString*)os;
+-(void)setTarget:(NSString*)target;
 
 @property(readonly, retain) NSMutableArray *SSDPObjCDevices;
 
diff --git a/ssdp/SSDPDB_ObjC.mm b/ssdp/SSDPDB_ObjC.mm
index 8314b14..a6c7fe0 100755
--- a/ssdp/SSDPDB_ObjC.mm
+++ b/ssdp/SSDPDB_ObjC.mm
@@ -154,12 +154,20 @@ private:
     }
 }
 
+-(void)setTarget:(NSString*)target{
+    if(target != nil){
+        const char *c_target = [target cStringUsingEncoding:NSASCIIStringEncoding];
+        UPNP::GetInstance()->GetSSDP()->SetTarget(c_target);
+    }
+}
+
+
 -(void)SSDPDBUpdate{
 	[NSRunLoop currentRunLoop]; //Start our runloop
 	
 	NSAutoreleasePool *pool = [[NSAutoreleasePool alloc] init];
 
-	SSDPDB_ObjC_Observer *obs;
+	id<SSDPDB_ObjC_Observer> obs;
 	
 	//Inform the listeners
 	NSEnumerator *listeners = [mObservers objectEnumerator];
diff --git a/ssdp/ssdp.cpp b/ssdp/ssdp.cpp
index 818e241..22a2c5d 100755
--- a/ssdp/ssdp.cpp
+++ b/ssdp/ssdp.cpp
@@ -41,7 +41,7 @@
 
 
 
-SSDP::SSDP():mMulticastSocket(INVALID_SOCKET), mUnicastSocket(INVALID_SOCKET), mReadLoop(0), mTTL(2), mOS("mac/1.0"), mProduct("upnpx/1.0"){
+SSDP::SSDP():mMulticastSocket(INVALID_SOCKET), mUnicastSocket(INVALID_SOCKET), mReadLoop(0), mTTL(2), mOS("mac/1.0"), mProduct("upnpx/1.0"), mTarget("ssdp:all") {
 	mDB = new SSDPDB();
 	mDB->Start();
 	mParser = new SSDPParser(mDB);
@@ -215,7 +215,7 @@ int SSDP::Stop(){
 //Multicast M-Search
 int SSDP::Search(){
 	u32 seconds = 3;
-	char target[]="ssdp:all";
+	const char *target=mTarget.c_str();
 	const char *os=mOS.c_str();
 	const char *product=mProduct.c_str();
 	
@@ -268,9 +268,15 @@ void SSDP::SetProduct(const char* product){
         mProduct = product;
 }
 
+void SSDP::SetTarget(const char* target){
+    if(target)
+        mTarget = target;
+}
+
 
 std::string mOS;
-std::string mProcuct;
+std::string mProduct;
+std::string mTarget;
 
 
 
diff --git a/ssdp/ssdp.h b/ssdp/ssdp.h
index ddd2324..560a19f 100755
--- a/ssdp/ssdp.h
+++ b/ssdp/ssdp.h
@@ -63,7 +63,8 @@ public:
 	int Advertise();
 	int Search();
     void SetOS(const char* os);
-    void SetProduct(const char* product);    
+    void SetProduct(const char* product);
+    void SetTarget(const char* target);
 	SSDPDB* GetDB();
 private:
 	SOCKET mMulticastSocket;
@@ -80,6 +81,7 @@ private:
 	fd_set mReadFDS;
 	fd_set mWriteFDS;
 	u16 mTTL;
+    std::string mTarget;
     std::string mOS;
     std::string mProduct;
 	SSDPParser* mParser;
-- 
1.7.8.3

